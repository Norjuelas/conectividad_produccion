<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visor ISED - CNC Project</title>

<!-- ================= LIBRERÃAS ================= -->
<script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
<script src="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,Roboto;background:#111;overflow:hidden}

/* MAPA */
#map{position:absolute;top:0;left:0;width:100vw;height:100vh}

/* PANEL UI */
#controls{
    position:absolute;top:15px;left:15px;width:330px;
    background:#fff;z-index:100;padding:18px;border-radius:8px;
    box-shadow:0 4px 15px rgba(0,0,0,.3)
}
#controls h3{margin-bottom:10px;color:#1c2d40;border-bottom:2px solid #eee;padding-bottom:8px}

.filter-group{margin-bottom:10px}
.filter-group label{font-size:12px;font-weight:600;margin-bottom:3px;color:#444;display:block}
select,input{
    width:100%;padding:7px;border:1px solid #ccc;border-radius:4px;
    font-size:14px;background:#ffffff
}

.btn-map{
    width:100%;padding:10px;background:#0066cc;color:#fff;
    border:none;border-radius:4px;font-weight:bold;cursor:pointer
}
.btn-map:hover{background:#004f9e}

/* Leyenda */
#legend{margin-top:10px;font-size:12px}
#legend div{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.legend-dot{width:10px;height:10px;border-radius:50%}

/* Tooltip */
#tooltip{
    position:absolute;z-index:999;background:rgba(0,0,0,.85);
    color:#fff;padding:12px;border-radius:6px;
    font-size:13px;line-height:1.5;display:none;max-width:260px
}
.tooltip-title{font-weight:bold;color:#49c6ff;border-bottom:1px solid #666;margin-bottom:4px;display:block}

/* Loading */
#loading{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#000c;padding:15px 30px;border-radius:6px;color:#fff;
    font-weight:bold;font-size:16px;display:none
}
</style>
</head>

<body>

<div id="map"></div>
<div id="tooltip"></div>

<!-- ================= PANEL CONTROL ================= -->
<div id="controls">
<h3>ğŸ›ï¸ Panel ISED</h3>

<div class="filter-group">
<label>Dataset</label>
<select id="dataset">
<option value="sena_ised" selected>SENA ISED (Conectividad)</option>
<option value="sedes_mock">Base UbicaciÃ³n Antigua</option>
</select>
</div>

<div class="filter-group">
<label>Tipo de visualizaciÃ³n</label>
<select id="layer-type">
<option value="scatterplot">Puntos</option>
<option value="heatmap">Mapa Calor</option>
<option value="column">Barras 3D</option>
</select>
</div>

<!-- ================== FILTROS ISED ==================== -->
<div id="ised-filters">

<div class="filter-group">
<label>ğŸ“… AÃ±o</label>
<select id="f_year">
<option value="">Todos</option>
<option>2022</option>
<option>2023</option>
</select>
</div>

<div class="filter-group">
<label>ğŸ“¶ Conectividad</label>
<select id="f_conectividad">
<option value="">Todas</option>
<option value="SI">Conectado</option>
<option value="NO">Sin conexiÃ³n</option>
</select>
</div>

<div class="filter-group">
<label>ğŸ“¡ TecnologÃ­a</label>
<select id="f_tecnologia">
<option value="">Todas</option>
<option value="FIBRA">Fibra Ã“ptica</option>
<option value="RADIO">Radio Enlace</option>
<option value="SATELITAL">Satelital</option>
</select>
</div>

<div class="filter-group">
<label>ğŸ”‹ Mbps mÃ­nimo</label>
<input type="number" id="f_mbps" placeholder="Ej: 20">
</div>

<div class="filter-group">
<label>ğŸ’» Equipos mÃ­nimos</label>
<input type="number" id="f_equipos" placeholder="Ej: 30">
</div>

<div class="filter-group">
<label>ğŸ“Š Ratio mÃ­nimo Est/Terminal</label>
<input type="number" step="0.1" id="f_ratio" placeholder="Ej: 4.5">
</div>

<div class="filter-group">
<label>ğŸ“ Municipio</label>
<input type="text" id="f_mpio" placeholder="Ej: NariÃ±o">
</div>
</div>

<button class="btn-map" onclick="updateMap()">ğŸ”„ Actualizar</button>

<div id="legend" style="margin-top:10px">
<div><span class="legend-dot" style="background:#00ff64"></span> Conectado</div>
<div><span class="legend-dot" style="background:#ff3c3c"></span> No conectado</div>
</div>

<p style="margin-top:10px;font-size:12px;color:#333">
Registros: <b id="point-count">0</b>
</p>
</div>

<div id="loading"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>

<script>
const API='http://localhost:8000';
let deckgl;

/* ====================== MAPA ====================== */
function initMap(){
    deckgl=new deck.DeckGL({
        container:'map',
        map:maplibregl,
        mapStyle:'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        initialViewState:{longitude:-74.1,latitude:4.6,zoom:5},
        controller:true,
        getTooltip:info=>info.object?info.object.properties.nombre_sede:null
    });
    updateMap();
}

/* ================= CONSULTA API ================= */
async function updateMap(){

    const dataset = document.getElementById("dataset").value;

    let params=new URLSearchParams({format:"geojson"});

    let year = document.getElementById("f_year").value;
    if(year) params.append("anno_inf",year);

    let cto = document.getElementById("f_conectividad").value;
    if(cto) params.append("conectividad_def",cto);

    let tech=document.getElementById("f_tecnologia").value;
    if(tech) params.append("tecnologia_conec",tech);

    let mbps=document.getElementById("f_mbps").value;
    if(mbps) params.append("min_mbps",mbps);

    let eq=document.getElementById("f_equipos").value;
    if(eq) params.append("min_equipos",eq);

    let r=document.getElementById("f_ratio").value;
    if(r) params.append("min_ratio_terminales",r);

    let mpio=document.getElementById("f_mpio").value;
    if(mpio) params.append("municipio",mpio);

    document.getElementById("loading").style.display="block";
    const res = await fetch(`${API}/data/${dataset}?${params}`);
    const geo = await res.json();
    document.getElementById("loading").style.display="none";

    renderLayer(geo.features || []);
    document.getElementById("point-count").innerText=geo.features.length;
}

/* ================= CAPA VISUALIZACIÃ“N ================= */
function renderLayer(data){

    const colors=d=>{
        let x=d.properties.conectividad_def;
        return x==="SI"?[0,255,100]:[255,60,60];
    };

    let lyr = new deck.GeoJsonLayer({
        id:'ised',
        data, pickable:true, filled:true, pointRadiusMinPixels:4,
        getFillColor:colors,
        onHover:i=>{
            if(!i.object) return tooltip(false);
            let p=i.object.properties;
            tooltip(true,i.x,i.y,`
                <span class='tooltip-title'>${p.nombre_sede}</span>
                ğŸ« ${p.nombre_establecimiento}<br>
                ğŸ“¶ ${p.conectividad_def}<br>
                ğŸ’» Equipos: ${p.total_equipos}<br>
                ğŸ“¡ ${p.tecnologia_conec}<br>
                ğŸ”‹ ${p.anchodebandaconsolidadombps} Mbps<br>
            `);
        }
    });

    deckgl.setProps({layers:[lyr]});
}

function tooltip(show,x,y,html=""){
    let t=document.getElementById("tooltip");
    if(!show) return t.style.display="none";
    t.style.display="block";t.innerHTML=html;
    t.style.left=x+"px";t.style.top=y+"px";
}

window.onload=initMap;
</script>

</body>
</html>
